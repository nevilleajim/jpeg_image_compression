
# Standard JPEG Luminance DC Huffman Table
DC_LUMA_HUFF = {
    0: ("00", 2), 1: ("010", 3), 2: ("011", 3), 3: ("100", 3),
    4: ("101", 3), 5: ("110", 3), 6: ("1110", 4), 7: ("11110", 5),
    8: ("111110", 6), 9: ("1111110", 7), 10: ("11111110", 8), 
    11: ("111111110", 9)
}

AC_LUMA_HUFF = {
    (0, 0):  ("1010",                  4),   # EOB
    (0, 1):  ("00",                    2),
    (0, 2):  ("01",                    2),
    (0, 3):  ("100",                   3),
    (0, 4):  ("1011",                  4),
    (0, 5):  ("11010",                 5),
    (0, 6):  ("1111000",               7),
    (0, 7):  ("11111000",              8),
    (0, 8):  ("1111110110",           10),
    (0, 9):  ("1111111110000010",      16),
    (0, 10): ("1111111110000011",      16),

    (1, 1):  ("1100",                  4),
    (1, 2):  ("11011",                 5),
    (1, 3):  ("1111001",               7),
    (1, 4):  ("111110110",             9),
    (1, 5):  ("11111110110",          11),
    (1, 6):  ("1111111110000100",      16),
    (1, 7):  ("1111111110000101",      16),
    (1, 8):  ("1111111110000110",      16),
    (1, 9):  ("1111111110000111",      16),
    (1, 10): ("1111111110001000",      16),

    (2, 1):  ("11100",                 5),
    (2, 2):  ("11111001",              8),
    (2, 3):  ("1111110111",           10),
    (2, 4):  ("111111110100",         12),
    (2, 5):  ("1111111110001001",      16),
    (2, 6):  ("1111111110001010",      16),
    (2, 7):  ("1111111110001011",      16),
    (2, 8):  ("1111111110001100",      16),
    (2, 9):  ("1111111110001101",      16),
    (2, 10): ("1111111110001110",      16),

    (3, 1):  ("111010",                6),
    (3, 2):  ("111110111",             9),
    (3, 3):  ("111111110101",         12),
    (3, 4):  ("1111111110001111",      16),
    (3, 5):  ("1111111110010000",      16),
    (3, 6):  ("1111111110010001",      16),
    (3, 7):  ("1111111110010010",      16),
    (3, 8):  ("1111111110010011",      16),
    (3, 9):  ("1111111110010100",      16),
    (3, 10): ("1111111110010101",      16),

    (4, 1):  ("111011",                6),
    (4, 2):  ("1111111000",           10),
    (4, 3):  ("1111111110010110",      16),
    (4, 4):  ("1111111110010111",      16),
    (4, 5):  ("1111111110011000",      16),
    (4, 6):  ("1111111110011001",      16),
    (4, 7):  ("1111111110011010",      16),
    (4, 8):  ("1111111110011011",      16),
    (4, 9):  ("1111111110011100",      16),
    (4, 10): ("1111111110011101",      16),

    (5, 1):  ("1111010",               7),
    (5, 2):  ("11111110111",          11),
    (5, 3):  ("1111111110011110",      16),
    (5, 4):  ("1111111110011111",      16),
    (5, 5):  ("1111111110100000",      16),
    (5, 6):  ("1111111110100001",      16),
    (5, 7):  ("1111111110100010",      16),
    (5, 8):  ("1111111110100011",      16),
    (5, 9):  ("1111111110100100",      16),
    (5, 10): ("1111111110100101",      16),

    (6, 1):  ("1111011",               7),
    (6, 2):  ("111111110110",         12),
    (6, 3):  ("1111111110100110",      16),
    (6, 4):  ("1111111110100111",      16),
    (6, 5):  ("1111111110101000",      16),
    (6, 6):  ("1111111110101001",      16),
    (6, 7):  ("1111111110101010",      16),
    (6, 8):  ("1111111110101011",      16),
    (6, 9):  ("1111111110101100",      16),
    (6, 10): ("1111111110101101",      16),

    (7, 1):  ("11111010",              8),
    (7, 2):  ("111111110111",         12),
    (7, 3):  ("1111111110101110",      16),
    (7, 4):  ("1111111110101111",      16),
    (7, 5):  ("1111111110110000",      16),
    (7, 6):  ("1111111110110001",      16),
    (7, 7):  ("1111111110110010",      16),
    (7, 8):  ("1111111110110011",      16),
    (7, 9):  ("1111111110110100",      16),
    (7, 10): ("1111111110110101",      16),

    (8, 1):  ("111111000",            10),
    (8, 2):  ("111111111000000",      15),  # Note: some sources list length 15
    (8, 3):  ("1111111110110110",      16),
    (8, 4):  ("1111111110110111",      16),
    (8, 5):  ("1111111110111000",      16),
    (8, 6):  ("1111111110111001",      16),
    (8, 7):  ("1111111110111010",      16),
    (8, 8):  ("1111111110111011",      16),
    (8, 9):  ("1111111110111100",      16),
    (8, 10): ("1111111110111101",      16),

    (9, 1):  ("111111001",            10),
    (9, 2):  ("1111111110111110",      16),
    (9, 3):  ("1111111110111111",      16),
    (9, 4):  ("1111111111000000",      16),
    (9, 5):  ("1111111111000001",      16),
    (9, 6):  ("1111111111000010",      16),
    (9, 7):  ("1111111111000011",      16),
    (9, 8):  ("1111111111000100",      16),
    (9, 9):  ("1111111111000101",      16),
    (9, 10): ("1111111111000110",      16),

    (10, 1): ("111111010",            10),
    (10, 2): ("1111111111000111",      16),
    (10, 3): ("1111111111001000",      16),
    (10, 4): ("1111111111001001",      16),
    (10, 5): ("1111111111001010",      16),
    (10, 6): ("1111111111001011",      16),
    (10, 7): ("1111111111001100",      16),
    (10, 8): ("1111111111001101",      16),
    (10, 9): ("1111111111001110",      16),
    (10, 10):("1111111111001111",      16),

    (11, 1): ("1111111001",           10),
    (11, 2): ("1111111111010000",      16),
    (11, 3): ("1111111111010001",      16),
    (11, 4): ("1111111111010010",      16),
    (11, 5): ("1111111111010011",      16),
    (11, 6): ("1111111111010100",      16),
    (11, 7): ("1111111111010101",      16),
    (11, 8): ("1111111111010110",      16),
    (11, 9): ("1111111111010111",      16),
    (11, 10):("1111111111011000",      16),

    (12, 1): ("1111111010",           10),
    (12, 2): ("1111111111011001",      16),
    (12, 3): ("1111111111011010",      16),
    (12, 4): ("1111111111011011",      16),
    (12, 5): ("1111111111011100",      16),
    (12, 6): ("1111111111011101",      16),
    (12, 7): ("1111111111011110",      16),
    (12, 8): ("1111111111011111",      16),
    (12, 9): ("1111111111100000",      16),
    (12, 10):("1111111111100001",      16),

    (13, 1): ("11111111000",          11),
    (13, 2): ("1111111111100010",      16),
    (13, 3): ("1111111111100011",      16),
    (13, 4): ("1111111111100100",      16),
    (13, 5): ("1111111111100101",      16),
    (13, 6): ("1111111111100110",      16),
    (13, 7): ("1111111111100111",      16),
    (13, 8): ("1111111111101000",      16),
    (13, 9): ("1111111111101001",      16),
    (13, 10):("1111111111101010",      16),

    (14, 1): ("1111111111101011",     16),
    (14, 2): ("1111111111101100",      16),
    (14, 3): ("1111111111101101",      16),
    (14, 4): ("1111111111101110",      16),
    (14, 5): ("1111111111101111",      16),
    (14, 6): ("1111111111110000",      16),
    (14, 7): ("1111111111110001",      16),
    (14, 8): ("1111111111110010",      16),
    (14, 9): ("1111111111110011",      16),
    (14, 10):("1111111111110100",      16),

    (15, 0): ("11111111001",          11),  # ZRL
    (15, 1): ("1111111111110101",      16),
    (15, 2): ("1111111111110110",      16),
    (15, 3): ("1111111111110111",      16),
    (15, 4): ("1111111111111000",      16),
    (15, 5): ("1111111111111001",      16),
    (15, 6): ("1111111111111010",      16),
    (15, 7): ("1111111111111011",      16),
    (15, 8): ("1111111111111100",      16),
    (15, 9): ("1111111111111101",      16),
    (15, 10):("1111111111111110",      16),
}

def category(value):
    """JPEG category = number of bits needed to store magnitude."""
    if value == 0:
        return 0
    v = abs(value)
    c = 0
    while v > 0:
        v >>= 1
        c += 1
    return c

def value_bits(value, size):
    """Return JPEG value bits with sign encoding."""
    if size == 0:
        return ""
    
    if value >= 0:
        return format(value, f"0{size}b")
    
    mask = (1 << size) - 1
    return format(value & mask, f"0{size}b")

def encode_block(coeffs, last_dc): 
    """coeffs: kist 64 quantized value (zigzag ordered)
    last_dc: previous DC coefficient
    
    Returns bitstring and new last_dc
    """
    
    bits = ""
    
    dc = coeffs[0]
    diff = dc - last_dc
    cat = category(diff)
    huff_code, _ = DC_LUMA_HUFF[cat]
    bits += huff_code
    bits += value_bits(diff, cat)
    
    zero_run = 0
    
    for ac in coeffs[1:]:
        if ac == 0:
            zero_run += 1
            
            if zero_run == 16:
                huff, _ = AC_LUMA_HUFF[(15, 0)]
                bits += huff
                zero_run = 0
        
        else:
            size = category(ac)
            key = (zero_run, size)
            
            if key not in AC_LUMA_HUFF:
                raise ValueError(f"Huffman code for {key} not found.")
            
            huff, _ = AC_LUMA_HUFF[key]
            bits += huff
            
            bits += value_bits(ac, size)
            zero_run = 0
            
    if zero_run > 0:
        huff, _ = AC_LUMA_HUFF[(0, 0)]
        bits += huff
    return bits, dc

if __name__ == "__main__":
    test_block = [
        52, -3, 0, 0, 0, 0, 0, 0,
        2, -1, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0
    ]
    
    stream, new_dc = encode_block(test_block, last_dc=50)
    
    print("Huffman Encoded Bitstream:")
    print(stream)
    print("Final DC:", new_dc)